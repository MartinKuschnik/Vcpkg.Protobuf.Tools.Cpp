<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<ItemGroup>
		<PropertyPageSchema Include="$(MSBuildThisFileDirectory)Vcpkg.Protobuf.Tools.CPP.proto.xml" />
	</ItemGroup>

	<!-- Ensure protobuf generated files are cleaned when the project is cleaned -->
	<PropertyGroup>
		<CleanDependsOn>
			ProtobufClean;
			$(CleanDependsOn)
		</CleanDependsOn>
	</PropertyGroup>

	<!-- Determine the vcpkg installation directory based on project configuration -->
	<PropertyGroup Condition="$(VcpkgInstalledDir)==''">
		<VcpkgInstallDir>$(VcpkgRoot.Trim('\\'))\installed\x64-windows\</VcpkgInstallDir>
	</PropertyGroup>

	<PropertyGroup Condition="$(VcpkgInstalledDir)!=''">
		<VcpkgInstallDir>$(VcpkgInstalledDir.Trim('\\'))\x64-windows\</VcpkgInstallDir>
	</PropertyGroup>

	<!-- Configure when protobuf generation should run based on vcpkg manifest mode -->
	<PropertyGroup Condition="$(VcpkgEnableManifest)!='true'">
		<ProtobufAfterTargets>PrepareForBuild</ProtobufAfterTargets>
	</PropertyGroup>

	<PropertyGroup Condition="$(VcpkgEnableManifest)=='true'">
		<ProtobufAfterTargets>VcpkgInstallManifestDependencies</ProtobufAfterTargets>
	</PropertyGroup>

	<!-- Define paths for protobuf tools and output directories -->
	<PropertyGroup>
		<ProtobufDir>$(VcpkgInstallDir)tools\protobuf\</ProtobufDir>
		<ProtobufOutDir>$(IntDir)protobuf\</ProtobufOutDir>
	</PropertyGroup>

	<!-- Add generated source directories to include paths and required libraries for linking -->
	<ItemDefinitionGroup>
		<ClCompile>
			<AdditionalIncludeDirectories>
				%(ClCompile.AdditionalIncludeDirectories);
				$(ProtobufOutDir);
			</AdditionalIncludeDirectories>
		</ClCompile>
		<Link>
			<AdditionalDependencies>ws2_32.lib;%(AdditionalDependencies)</AdditionalDependencies>
		</Link>
	</ItemDefinitionGroup>

	<!-- Validate that required tools exist and add generated .cc files to the compilation -->
	<Target Name="_PrepareProtobufCompilation" AfterTargets="$(ProtobufAfterTargets)">

		<Error Condition="$(VcpkgEnabled)!='true'" Text="Vcpkg not enabled. See https://github.com/microsoft/vcpkg#getting-started for more details." />

		<Error Condition="!Exists('$(ProtobufDir)protoc.exe') AND $(VcpkgEnableManifest)!='true'" Text="protobuf not installed. Use 'vcpkg install protobuf:$(PlatformTarget)-windows' to install Protobuf." />
		<Error Condition="!Exists('$(ProtobufDir)protoc.exe') AND $(VcpkgEnableManifest)=='true'" Text="protobuf not found. Add protobuf as dependency to the 'vcpkg.json' file." />

		<!-- The .cc files must be in this target, otherwise these files would be displayed in the Solution Explorer, which is not desired. -->
		<ItemGroup>
			<ClCompile WarningLevel="TurnOffAllWarnings" Include="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.cc')" />
		</ItemGroup>

	</Target>

	<!-- Configure CustomBuild to run after validation and before C++ compilation -->
	<PropertyGroup>
		<CustomBuildAfterTargets>_PrepareProtobufCompilation</CustomBuildAfterTargets>
		<CustomBuildBeforeTargets>ClCompile</CustomBuildBeforeTargets>
	</PropertyGroup>

	<ItemGroup>

		<!-- Unfortunately, the detection of file changes in C++ projects does not work as expected, unlike in C# projects. -->
		<!-- This has the consequence that file changes to a .proto file do not trigger a recompilation. -->
		<!-- The following approach using CustomBuild solves this problem, but unfortunately has a disadvantage: -->
		<!-- The ItemType "ProtobufCompile" cannot be specified in the ProjectSchemaDefinitions as expected, because Visual Studio shows the following error when loading the project: -->
		<!-- Cannot load project with duplicated project items: xxx.proto is included as 'CustomBuild' and as 'ProtobufCompile' item types. -->
		<CustomBuild Include="@(ProtobufCompile)">
			<Outputs>
				$(ProtobufOutDir)%(Filename).pb.h;
				$(ProtobufOutDir)%(Filename).pb.cc;
			</Outputs>
			<Message>%(Filename)%(Extension)</Message>
			<Command>"$(ProtobufDir)protoc.exe" --cpp_out="$(ProtobufOutDir.Trim('\\'))" --proto_path=%(RootDir)%(Directory) %(FullPath)</Command>
		</CustomBuild>
	</ItemGroup>

	<!-- Clean protobuf generated files -->
	<Target Name="ProtobufClean">
		<Delete Files="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.h')" />
		<Delete Files="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.cc')" />
	</Target>
</Project>
