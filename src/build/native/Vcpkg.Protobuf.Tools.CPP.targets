<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<ItemGroup>
		<PropertyPageSchema Include="$(MSBuildThisFileDirectory)Vcpkg.Protobuf.Tools.CPP.proto.xml" />
	</ItemGroup>

	<!-- Ensure protobuf generated files are cleaned when the project is cleaned -->
	<PropertyGroup>
		<CleanDependsOn>
			ProtobufClean;
			$(CleanDependsOn)
		</CleanDependsOn>
	</PropertyGroup>

	<!-- Determine the vcpkg installation directory based on project configuration -->
	<PropertyGroup Condition="$(VcpkgInstalledDir)==''">
		<VcpkgInstallDir>$(VcpkgRoot.Trim('\\'))\installed\x64-windows\</VcpkgInstallDir>
	</PropertyGroup>

	<PropertyGroup Condition="$(VcpkgInstalledDir)!=''">
		<VcpkgInstallDir>$(VcpkgInstalledDir.Trim('\\'))\x64-windows\</VcpkgInstallDir>
	</PropertyGroup>

	<!-- Configure when protobuf generation should run based on vcpkg manifest mode -->
	<PropertyGroup Condition="$(VcpkgEnableManifest)!='true'">
		<ProtobufAfterTargets>PrepareForBuild</ProtobufAfterTargets>
	</PropertyGroup>

	<PropertyGroup Condition="$(VcpkgEnableManifest)=='true'">
		<ProtobufAfterTargets>VcpkgInstallManifestDependencies</ProtobufAfterTargets>
	</PropertyGroup>

	<!-- Define paths for protobuf tools and output directories -->
	<PropertyGroup>
		<ProtobufExePath>$(VcpkgInstallDir)tools\protobuf\protoc.exe</ProtobufExePath>
		<ProtobufOutDir>$(IntDir)protobuf\</ProtobufOutDir>
	</PropertyGroup>

	<!-- Add generated source directories to include paths and required libraries for linking -->
	<ItemDefinitionGroup>
		<ClCompile>
			<AdditionalIncludeDirectories>
				%(ClCompile.AdditionalIncludeDirectories);
				$(ProtobufOutDir);
			</AdditionalIncludeDirectories>
		</ClCompile>
		<Link>
			<AdditionalDependencies>ws2_32.lib;%(AdditionalDependencies)</AdditionalDependencies>
		</Link>
	</ItemDefinitionGroup>

	<!-- 
	
	The build process is a bit "tricky".
	
	Normally, a single build step as a target that runs after vcpkg and compiles the .proto files would be sufficient.
	Unfortunately, the detection of changes to .proto files during targets in C++ projects does not work as expected,
	and modifying a .proto file does not trigger a recompilation.
	This would require always doing a rebuild, which is slow and annoying.
	
	However, C++ projects do allow the use of CustomBuilds, which always run before vcpkg.
	But this CustomBuild also have some issues:
	
		- Runs very early in the build sequence and unfortunately cannot be moved later (after vcpkg).
		
		- Condition does not work as expected because the expressions (e.g. Exists(...)) are evaluated only once before any target runs.
		
		- The CustomBuild can not be defined by a Target, because this would also break change detection.
		
		- The required protoc.exe is not yet available on the first build at this moment, because vcpkg runs afterwards
	
	To solve these problem, the following process was created:
		
	Stage 1 - Protobuf Configure via Target
	
		The target must run before vcpkg and configures the property ProtoCompileTwice depending on whether the protoc.exe already exists before vcpkg runs.
		This property is used later for Stage 3 to detect if it is necessary to compile a second time after vcpkg.
	
	Stage 2 - Protobuf Compile via CustomBuilds 	
	
		Only executes if the protoc.exe file exists.
		Since this is the case for most builds, recompilation is performed when a .proto file changes.
		
	>>>>>>>>>>>>>>>>>>>>>>>>>     vcpkg runs     <<<<<<<<<<<<<<<<<<<<<<<<<	
	
	Stage 3 - Protobuf Compile via Target 

		This step is only executed if Stage 1 configured the Property ProtoCompileTwice to true.
		This should only be the case very rarely.
		
	Stage 4 - Protobuf Finalize via Target 
	
		Now the generated files are added to the project so they can be compiled by the C++ compiler.
	
	-->

	<!-- Stage 1 -->
	<Target Name="ProtobufConfigure" BeforeTargets="CustomBuild">

		<PropertyGroup Condition="Exists('$(ProtobufExePath)')">
			<ProtoCompileTwice>false</ProtoCompileTwice>
		</PropertyGroup>
		<PropertyGroup Condition="!Exists('$(ProtobufExePath)')">
			<ProtoCompileTwice>true</ProtoCompileTwice>
		</PropertyGroup>

	</Target>


	<ItemGroup>

		<!-- Stage 2 -->

		<!-- Unfortunately, the detection of file changes in C++ projects does not work as expected, unlike in C# projects. -->
		<!-- This has the consequence that file changes to a .proto file do not trigger a recompilation. -->
		<!-- The following approach using CustomBuild solves this problem, but unfortunately has a disadvantage: -->
		<!-- The ItemType "ProtobufCompile" cannot be specified in the ProjectSchemaDefinitions as expected, because Visual Studio shows the following error when loading the project: -->
		<!-- Cannot load project with duplicated project items: xxx.proto is included as 'CustomBuild' and as 'ProtobufCompile' item types. -->
		<CustomBuild Include="@(ProtobufCompile)">
			<Outputs>
				$(ProtobufOutDir)%(Filename).pb.h;
				$(ProtobufOutDir)%(Filename).pb.cc;
			</Outputs>
			<Message>%(Filename)%(Extension)</Message>
			<Command>
				IF EXIST "$(ProtobufExePath)" (
				"$(ProtobufExePath)" --cpp_out="$(ProtobufOutDir.Trim('\\'))" --proto_path=%(RootDir)%(Directory) %(FullPath)
				)
			</Command>
		</CustomBuild>

	</ItemGroup>

	<!-- Stage 3 -->
	<Target Name="ProtobufCompile" AfterTargets="$(ProtobufAfterTargets)" Condition="$(ProtoCompileTwice)"
			Outputs="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.h');@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.cc')">

		<Error Condition="$(VcpkgEnabled)!='true'" Text="Vcpkg not enabled. See https://github.com/microsoft/vcpkg#getting-started for more details." />

		<Error Condition="!Exists('$(ProtobufExePath)') AND $(VcpkgEnableManifest)!='true'" Text="protobuf not installed. Use 'vcpkg install protobuf:$(PlatformTarget)-windows' to install Protobuf." />
		<Error Condition="!Exists('$(ProtobufExePath)') AND $(VcpkgEnableManifest)=='true'" Text="protobuf not found. Add protobuf as dependency to the 'vcpkg.json' file." />

		<PropertyGroup>
			<ProtoPath>%(ProtobufCompile.RootDir)\%(ProtobufCompile.Directory)</ProtoPath>
		</PropertyGroup>

		<!-- Required for first build -->
		<MakeDir Directories="$(ProtobufOutDir)" Condition="!Exists('$(ProtobufOutDir)')" />

		<Message Text="%(ProtobufCompile.Filename)%(ProtobufCompile.Extension)" Importance="high" />

		<Exec Command="&quot;$(ProtobufExePath)&quot; --cpp_out=&quot;$(ProtobufOutDir.Trim('\\'))&quot; --proto_path=&quot;$(ProtoPath.Trim('\\'))&quot; &quot;%(ProtobufCompile.FullPath)&quot;" />

	</Target>

	<!-- Stage 4 -->
	<Target Name="ProtobufFinalize" AfterTargets="ProtobufCompile">

		<!-- The .cc files must be in this target, otherwise these files would be displayed in the Solution Explorer, which is not desired. -->
		<ItemGroup>
			<ClCompile WarningLevel="TurnOffAllWarnings" Include="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.cc')" />
		</ItemGroup>

	</Target>

	<!-- Clean protobuf generated files -->
	<Target Name="ProtobufClean">
		<Delete Files="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.h')" />
		<Delete Files="@(ProtobufCompile->'$(ProtobufOutDir)%(Filename).pb.cc')" />
	</Target>
</Project>
